<!-- templates/eye_tracking.html -->
{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2><i class="fas fa-eye"></i> Eye Tracking Assessment</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            Eye Tracking Simulation
                        </div>
                        <div class="card-body">
                            <div class="eye-tracking-area" id="eye-tracking-area">
                                <img src="{{ url_for('static', filename='img/eye-tracking.jpg') }}" 
                                     alt="Face for eye tracking">
                                <canvas id="gaze-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                            </div>
                            <button id="start-tracking" class="btn btn-primary mt-3 w-100">
                                <i class="fas fa-play"></i> Start Eye Tracking
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i> Instructions
                        </div>
                        <div class="card-body">
                            <p>Please look at the image naturally for 30 seconds. The system will track your eye movements.</p>
                            <ul>
                                <li>Look at the eyes</li>
                                <li>Look at the mouth</li>
                                <li>Look at the objects</li>
                                <li>Try to follow a natural gaze pattern</li>
                            </ul>
                            <div class="text-center mt-4">
                                <h4>Time Remaining</h4>
                                <div id="timer" class="display-4">00:30</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="results" class="card mt-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-check-circle"></i> Analysis Complete
                </div>
                <div class="card-body">
                    <p>Processing your eye tracking data and generating results...</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('start-tracking');
    const timerDisplay = document.getElementById('timer');
    const resultsDiv = document.getElementById('results');
    const canvas = document.getElementById('gaze-canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas dimensions
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    let tracking = false;
    let startTime;
    let timer;
    let gazePoints = [];
    
    // Simulated eye tracking data
    function simulateGaze() {
        if (!tracking) return;
        
        // Random gaze point
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        
        // Store point
        gazePoints.push({x, y, timestamp: Date.now()});
        
        // Draw point
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
        
        // Schedule next point
        setTimeout(simulateGaze, 100 + Math.random() * 200);
    }
    
    function startTracking() {
        tracking = true;
        startTime = Date.now();
        gazePoints = [];
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        startButton.disabled = true;
        resultsDiv.style.display = 'none';
        
        // Start simulation
        simulateGaze();
        
        // Start timer
        let seconds = 30;
        timerDisplay.textContent = '00:' + (seconds < 10 ? '0' + seconds : seconds);
        
        timer = setInterval(() => {
            seconds--;
            timerDisplay.textContent = '00:' + (seconds < 10 ? '0' + seconds : seconds);
            
            if (seconds <= 0) {
                clearInterval(timer);
                tracking = false;
                startButton.disabled = false;
                resultsDiv.style.display = 'block';
                
                // Send data to server
                sendGazeData();
            }
        }, 1000);
    }
    
    function sendGazeData() {
        // Process gaze data
        const fixations = Math.floor(gazePoints.length / 10);
        const saccades = Math.floor(gazePoints.length / 5);
        const pupilDilation = (3.5 + Math.random()).toFixed(1);
        
        // Calculate attention areas
        const areas = {
            eyes: 0,
            mouth: 0,
            objects: 0
        };
        
        gazePoints.forEach(point => {
            // Simplified: top-left is eyes, center is mouth, right is objects
            if (point.x < canvas.width/2 && point.y < canvas.height/2) {
                areas.eyes++;
            } else if (point.x > canvas.width/3 && point.x < 2*canvas.width/3 && 
                       point.y > canvas.height/3 && point.y < 2*canvas.height/3) {
                areas.mouth++;
            } else {
                areas.objects++;
            }
        });
        
        // Normalize
        const total = areas.eyes + areas.mouth + areas.objects;
        areas.eyes = Math.round((areas.eyes / total) * 100);
        areas.mouth = Math.round((areas.mouth / total) * 100);
        areas.objects = Math.round((areas.objects / total) * 100);
        
        // Send to server
        fetch('/simulate-eye-tracking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fixations: fixations,
                saccades: saccades,
                pupilDilation: pupilDilation,
                attentionAreas: areas
            })
        })
        .then(response => response.json())
        .then(data => {
            // Redirect to results page
            window.location.href = '/results';
        });
    }
    
    startButton.addEventListener('click', startTracking);
});
</script>
{% endblock %}
<!-- Add this at the bottom of the template -->
<script src="{{ url_for('static', filename='js/eye-tracking.js') }}"></script>