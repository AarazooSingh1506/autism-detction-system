<!-- templates/admin/dashboard.html -->
{% extends "admin/base.html" %}

{% block header %}Dashboard{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-md-3">
        <div class="dashboard-card card-primary">
            <i class="fas fa-users"></i>
            <h3>Users</h3>
            <h2>{{ users }}</h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card card-success">
            <i class="fas fa-clipboard-list"></i>
            <h3>Assessments</h3>
            <h2>{{ assessments }}</h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card card-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Positive Cases</h3>
            <h2>{{ positive }}</h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="dashboard-card card-danger">
            <i class="fas fa-chart-line"></i>
            <h3>Avg. Risk</h3>
            <h2>{{ ((positive / assessments) * 100) | round(2) if assessments > 0 else 0 }}%</h2>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Age Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="ageChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Gender Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="genderChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Prediction Distribution</h5>
            </div>
            <div class="card-body">
                <img src="data:image/png;base64,{{ prediction_chart }}" alt="Prediction Distribution" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Assessments</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Date</th>
                                <th>Prediction</th>
                                <th>Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assessment in recent_assessments %}
                            <tr>
                                <td>{{ assessment['id'] }}</td>
                                <td>{{ assessment['username'] }}</td>
                                <td>{{ assessment['age'] }}</td>
                                <td>{{ assessment['gender'] }}</td>
                                <td>{{ assessment['timestamp'] }}</td>
                                <td>{{ (assessment['prediction'] * 100) | round(2) }}%</td>
                                <td>
                                    {% set risk = assessment['prediction'] * 100 %}
                                    {% if risk > 70 %}
                                    <span class="badge bg-danger">High</span>
                                    {% elif risk > 40 %}
                                    <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                    <span class="badge bg-success">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Age distribution chart
    const ageLabels = {{ ages | tojson }};
    const ageData = {{ age_counts | tojson | safe }};
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    const ageChart = new Chart(ageCtx, {
        type: 'bar',
        data: {
            labels: ageLabels,
            datasets: [{
                label: 'Number of Assessments',
                data: ageData,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    // Gender distribution chart
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    const genderChart = new Chart(genderCtx, {
        type: 'doughnut',
        data: {
            labels: {{ genders | tojson }},
            datasets: [{
                data: {{ gender_counts | tojson | default('[]') | safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)'
                ],
                borderWidth: 1
            }],
        },
        options: {
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
</script>
{% endblock %}